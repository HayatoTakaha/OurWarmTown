<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card" style="background-color: #FFFAF0;">
        <div class="card-body">
          <div class="row">
            <% if @post.images.attached? %>
              <div class="col-md-6 position-relative">
                <div class="row mb-3">
                  <% if @post.user.profile_image.attached? %>
                    <div class="position-absolute d-flex align-items-center" style="top: 10px; left: 10px; padding-bottom: 5px;">
                      <%= link_to user_path(@post.user), class: 'd-flex align-items-center', style: 'text-decoration: none;' do %>
                        <%= image_tag @post.user.profile_image, class: 'rounded-circle', width: '50', height: '50', alt: 'プロフィール画像' %>
                        <span class="ml-2" style="color: #5a5a5a;"><%= @post.user.name %></span>
                      <% end %>
                    </div>
                  <% end %>
                  <% @post.images.each do |image| %>
                    <div class="col-md-12 mb-2" style="margin-top: 70px;">
                      <%= image_tag image, class: 'img-fluid', alt: '投稿画像' %>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="col-md-6 d-flex flex-column justify-content-start">
                <p class="text-muted"><%= @post.created_at.in_time_zone('Tokyo').strftime("%Y年%m月%d日 %H:%M") %></p>
                <h2 class="card-title mt-3"><%= @post.title %></h2>
                <p class="card-text"><%= @post.content %></p>
              </div>
            <% else %>
              <div class="col-md-12">
                <% if @post.user.profile_image.attached? %>
                  <div class="d-flex align-items-center mb-3" style="padding-bottom: 5px;">
                    <%= link_to user_path(@post.user), class: 'd-flex align-items-center', style: 'text-decoration: none;' do %>
                      <%= image_tag @post.user.profile_image, class: 'rounded-circle', width: '50', height: '50', alt: 'プロフィール画像' %>
                      <span class="ml-2" style="color: #5a5a5a;"><%= @post.user.name %></span>
                    <% end %>
                  </div>
                <% end %>
                <p class="text-muted"><%= @post.created_at.in_time_zone('Tokyo').strftime("%Y年%m月%d日 %H:%M") %></p>
                <h2 class="card-title mt-3"><%= @post.title %></h2>
                <p class="card-text"><%= @post.content %></p>
              </div>
            <% end %>
          </div>
          <div class="d-flex justify-content-start mt-3">
            <div class="d-flex align-items-center">
              <%= link_to toggle_like_post_path(@post), method: :post, remote: true, id: 'like-link' do %>
                <i class="fas fa-heart mr-1" id="like-icon" style="cursor: pointer; <% if current_user.liked?(@post) %>color: red;<% end %>"></i>
              <% end %>
              <span class="mr-2" id="likes-count"><%= @post.likes.count %></span>
              <span id="like-text" style="cursor: pointer;"><%= current_user.liked?(@post) ? 'いいねを取り消す' : 'いいね' %></span>
            </div>
          </div>
          <div class="mt-3">
            <div class="d-flex align-items-center">
              <i class="fas fa-comment mr-1"></i>
              <span class="mr-2"><%= @post.comments.count %></span>
              <span id="comment-text" style="cursor: pointer;">コメント</span>
            </div>
            <div id="comments" style="display: none;">
              <% @post.comments.each do |comment| %>
                <div class="d-flex justify-content-between align-items-center">
                  <p class="mb-1"><strong><%= comment.user.name %>:</strong> <%= comment.content %></p>
                  <% if comment.user == current_user %>
                    <%= link_to '削除', post_comment_path(@post, comment), method: :delete, class: 'btn btn-danger btn-sm ml-2' %>
                  <% end %>
                </div>
              <% end %>
              <%= form_with(model: [@post, Comment.new], local: false, id: 'comment-form') do |form| %>
                <div class="form-group">
                  <%= form.label :content, "コメントを追加" %>
                  <%= form.text_area :content, rows: 3, class: "form-control" %>
                </div>
                <%= form.submit "コメントする", class: "btn btn-primary" %>
              <% end %>
            </div>
          </div>
          <% if @post.group %>
            <div class="mt-3">
              <i class="fas fa-users mr-1"></i>
              <span class="mr-2"><%= link_to truncate(@post.group.name, length: 12), group_path(@post.group) %></span>
            </div>
          <% end %>
          <div class="d-flex justify-content-start mt-3">
            <% if @post.user == current_user %>
              <%= link_to '編集', edit_post_path(@post), class: 'btn btn-secondary mr-2' %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    var likeIcon = document.getElementById("like-icon");
    var likesCount = document.getElementById("likes-count");
    var likeText = document.getElementById("like-text");

    likeIcon.addEventListener("click", function(event) {
      event.preventDefault();
      fetch("<%= toggle_like_post_path(@post) %>", {
        method: "POST",
        headers: {
          "X-CSRF-Token": "<%= form_authenticity_token %>",
          "Content-Type": "application/json"
        }
      }).then(response => response.json()).then(data => {
        if (data.liked) {
          likeIcon.style.color = "red";
          likeText.innerText = "いいねを取り消す";
        } else {
          likeIcon.style.color = "black";
          likeText.innerText = "いいねする";
        }
        likesCount.innerText = data.likes_count;
      });
    });

    var commentText = document.getElementById("comment-text");
    var comments = document.getElementById("comments");

    commentText.addEventListener("click", function() {
      comments.style.display = comments.style.display === "none" ? "block" : "none";
    });

    var commentForm = document.getElementById("comment-form");
    commentForm.addEventListener("submit", function(event) {
      event.preventDefault();
      var formData = new FormData(commentForm);
      fetch("<%= post_comments_path(@post) %>", {
        method: "POST",
        headers: {
          "X-CSRF-Token": "<%= form_authenticity_token %>",
          "Accept": "application/json"
        },
        body: formData
      }).then(response => response.json()).then(data => {
        if (data.success) {
          var newComment = document.createElement("div");
          newComment.classList.add("d-flex", "justify-content-between", "align-items-center");
          newComment.innerHTML = `<p class="mb-1"><strong>${data.user_name}:</strong> ${data.content}</p>`;
          if (data.user_id == <%= current_user.id %>) {
            var deleteButton = document.createElement("a");
            deleteButton.href = `/posts/${data.post_id}/comments/${data.comment_id}`;
            deleteButton.classList.add("btn", "btn-danger", "btn-sm", "ml-2");
            deleteButton.innerText = "削除";
            deleteButton.setAttribute("data-method", "delete");
            newComment.appendChild(deleteButton);
          }
          comments.insertBefore(newComment, commentForm);
          commentForm.reset();
        }
      });
    });
  });
</script>
